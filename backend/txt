<script lang="ts">
  import { createEventDispatcher, onDestroy,onMount } from 'svelte';
  import { api, handleApiError } from '../lib/api.ts';
  import type { ApiSuccessResponse } from '../lib/api.ts';

  // ========== ç±»å‹å®šä¹‰ ==========
  interface UploadImageResponseData {
    relative_path: string;
    [key: string]: any;
  }

  interface BatchDeleteImageRequest {
    featureIds: string[];
    imagePaths: string[];
    relatedProductIds?: string[];
    cleanCsv: boolean;
  }

  interface BatchDeleteImageResponse {
    status: 'success' | 'error' | 'partial_success';
    message: string;
    total: number;
    success_count: number;
    fail_count: number;
    details: Array<{
      type: 'featureId' | 'imagePath';
      id: string;
      status: 'success' | 'fail';
      message: string;
      image_path: string;
      image_deleted: boolean;
      csv_cleaned: boolean;
      remaining_references: number;
      full_image_path?: string;
    }>;
  }

  // æ–°å¢ï¼šä¸´æ—¶ä¸Šä¼ æ¥å£è¿”å›ç±»å‹
  interface TempUploadImageResponse {
    success: boolean;
    data: {
      tempImageId: string; // åç«¯è¿”å›çš„ä¸´æ—¶å›¾ç‰‡æ ‡è¯†
      expireAt?: string; // å¯é€‰ï¼šä¸´æ—¶æ–‡ä»¶è¿‡æœŸæ—¶é—´
    };
    message: string;
  }

  type ImageUploadEvents = {
    change: string;
  };

  // ========== äº‹ä»¶æ´¾å‘ ==========
  const dispatch = createEventDispatcher<ImageUploadEvents>();

  // ========== Props å®šä¹‰ ==========
  export let value: string | CustomEvent<string> | Record<string, any> = '';
  export let productCode: string = '';
  export let disabled: boolean = false;
  export let featureId: string | number = '';

  // ========== æ ¸å¿ƒé…ç½® ==========
  const IMAGE_API_BASE: string = 'http://127.0.0.1:5000/api/get_image';
  const IMAGE_STATIC_BASE: string = 'http://127.0.0.1:5000/image';
  const DELETE_IMAGE_API: string = 'http://127.0.0.1:5000/api/batch_delete_image';
  const ERROR_PLACEHOLDER: string = 'https://picsum.photos/40/40?grayscale&text=æ— å›¾';
  const ALLOWED_FORMATS: readonly string[] = ['png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp'];
  const MAX_FILE_SIZE: number = 16 * 1024 * 1024;
  const EDIT_IMAGE_URL: string = 'http://localhost:5174/';
  // æ–°å¢ï¼šåç«¯ä¸´æ—¶ä¸Šä¼ æ¥å£ï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼‰
  const TEMP_UPLOAD_API: string = 'http://127.0.0.1:5000/api/temp_upload_image';

  // ========== çŠ¶æ€å˜é‡ ==========
  let previewUrlCache: string = '';
  let imgLoadError: boolean = false;
  let debugPreviewUrl: string = '';
  let isUploading: boolean = false;
  let uploadProgress: number = 0;
  let isDeleting: boolean = false;
  let pendingFile: File | null = null;
  let pendingFilePreviewUrl: string = '';
  // æ–°å¢ï¼šä¸´æ—¶ä¸Šä¼ çŠ¶æ€
  let isTempUploading: boolean = false;

  // ========== å“åº”å¼å¤„ç† ==========
  $: safeValue = (() => {
    if (value && typeof value === 'object' && 'detail' in value) {
      return (value as CustomEvent<string>).detail || '';
    }
    if (value && typeof value === 'object' && !(value instanceof Event)) {
      return String(value) || '';
    }
    return String(value || '').trim();
  })();

  // ========== å·¥å…·å‡½æ•° ==========
  function getFileExtension(file: File): string {
    return file.name.split('.').pop()?.toLowerCase() || '';
  }

  /**
   * é€‰æ‹©æ–‡ä»¶åç¼“å­˜ï¼Œå±•ç¤ºå¾…ä¸Šä¼ åŒºåŸŸ
   */
  async function handleFileSelect(e: Event & { target: HTMLInputElement }): Promise<void> {
    const fileInput = e.target;
    const file = fileInput.files?.[0];
    fileInput.value = '';

    if (!productCode || productCode.trim() === '') {
      alert('é”™è¯¯ï¼šå•†å“è´§å·ä¸èƒ½ä¸ºç©ºï¼');
      return;
    }
    if (!file) return;

    const ext = getFileExtension(file);
    if (!ALLOWED_FORMATS.includes(ext)) {
      alert(`é”™è¯¯ï¼šä»…æ”¯æŒä¸Šä¼  ${ALLOWED_FORMATS.join('ã€')} æ ¼å¼çš„å›¾ç‰‡ï¼`);
      return;
    }
    if (file.size > MAX_FILE_SIZE) {
      alert('é”™è¯¯ï¼šå›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡16MBï¼Œè¯·å‹ç¼©åä¸Šä¼ ï¼');
      return;
    }

    pendingFile = file;
    pendingFilePreviewUrl = URL.createObjectURL(file);
  }

  /**
   * ç¼–è¾‘æŒ‰é’®ç‚¹å‡»å‡½æ•° - åç«¯ä¸­è½¬æ–‡ä»¶ï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼‰
   */
  async function editPendingImage(e: MouseEvent): Promise<void> {
    // é˜»æ­¢å†’æ³¡å’Œé»˜è®¤è¡Œä¸º
    e.stopPropagation();
    e.preventDefault();

    // åŸºç¡€æ ¡éªŒ
    if (!pendingFile) {
      alert('è¯·å…ˆé€‰æ‹©å¾…ä¸Šä¼ çš„å›¾ç‰‡ï¼Œå†ç‚¹å‡»ç¼–è¾‘ï¼');
      return;
    }
    if (isTempUploading) {
      alert('æ­£åœ¨ä¸Šä¼ ä¸´æ—¶å›¾ç‰‡ï¼Œè¯·ç¨å€™...');
      return;
    }

    try {
      isTempUploading = true;

      // 1. æ„å»ºFormDataï¼ˆæ–‡ä»¶æ ¼å¼ç›´æ¥ä¼ ç»™åç«¯ï¼‰
      const formData = new FormData();
      formData.append('image', pendingFile); // æ–‡ä»¶å­—æ®µ
      formData.append('productCode', productCode.trim()); // å¯é€‰ï¼šæºå¸¦å•†å“è´§å·
      formData.append('fileName', pendingFile.name); // å¯é€‰ï¼šæºå¸¦æ–‡ä»¶å

      // 2. è°ƒç”¨åç«¯ä¸´æ—¶ä¸Šä¼ æ¥å£
      const response = await fetch(TEMP_UPLOAD_API, {
        method: 'POST',
        body: formData,
        credentials: 'include', // ä¿æŒä¼šè¯ï¼ˆå¦‚éœ€ç™»å½•æ€ï¼‰
        headers: {
          // æ³¨æ„ï¼šFormData ä¸éœ€è¦æ‰‹åŠ¨è®¾ç½® Content-Typeï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨åŠ  boundary
          // é¿å…æ‰‹åŠ¨è®¾ç½®å¯¼è‡´åç«¯è§£æå¤±è´¥
        }
      });

      if (!response.ok) {
        throw new Error(`ä¸´æ—¶ä¸Šä¼ å¤±è´¥ [${response.status}]ï¼š${response.statusText}`);
      }

      // 3. è§£æåç«¯è¿”å›çš„ä¸´æ—¶æ ‡è¯†
      const tempResult: TempUploadImageResponse = await response.json();
      if (!tempResult.success || !tempResult.data?.tempImageId) {
        throw new Error(tempResult.message || 'ä¸´æ—¶ä¸Šä¼ å¤±è´¥ï¼Œæœªè·å–åˆ°å›¾ç‰‡ä¸´æ—¶ID');
      }

      // 4. è·³è½¬ç¼–è¾‘é¡µé¢ï¼ˆæºå¸¦ä¸´æ—¶IDï¼‰
      const tempImageId = tempResult.data.tempImageId;
      const editorUrl = `${EDIT_IMAGE_URL}?tempImageId=${encodeURIComponent(tempImageId)}`;
      window.open(editorUrl, '_blank');

      // å¯é€‰ï¼šæç¤ºä¸´æ—¶æ–‡ä»¶è¿‡æœŸæ—¶é—´
      if (tempResult.data.expireAt) {
        console.log(`ä¸´æ—¶å›¾ç‰‡è¿‡æœŸæ—¶é—´ï¼š${tempResult.data.expireAt}`);
      }

    } catch (err) {
      const errorMsg = (err as Error).message || 'ä¸´æ—¶ä¸Šä¼ å¤±è´¥';
      console.error('ã€ç¼–è¾‘è·³è½¬-ä¸´æ—¶ä¸Šä¼ é”™è¯¯ã€‘', err);
      alert(`ç¼–è¾‘è·³è½¬å¤±è´¥ï¼š${errorMsg}`);
    } finally {
      isTempUploading = false;
    }
  }
  // ========== æ–°å¢ï¼šç›‘å¬å‰ç«¯Bä¼ å›çš„ç¼–è¾‘åå›¾ç‰‡ ==========
    onMount(() => {
        // ç›‘å¬è·¨çª—å£æ¶ˆæ¯
        const handleMessage = (e: MessageEvent) => {
            // å®‰å…¨æ ¡éªŒï¼šåªæ¥æ”¶æŒ‡å®šæ¥æºçš„æ¶ˆæ¯ï¼ˆç”Ÿäº§ç¯å¢ƒæ›¿æ¢ä¸ºå‰ç«¯Bçš„åŸŸåï¼‰
            if (!e.origin.includes('localhost:5174')) return;

            // æ ¡éªŒæ¶ˆæ¯ç±»å‹
            if (e.data.type === 'EDITED_IMAGE') {
                const { data: editedImage, fileName } = e.data;

                // æƒ…å†µ1ï¼šå¦‚æœä¼ çš„æ˜¯Blobï¼ˆæ¨èï¼‰
                if (editedImage instanceof Blob) {
                    const editedFile = new File([editedImage], fileName, { type: editedImage.type });
                    // å¤ç”¨åŸæœ‰ä¸Šä¼ é€»è¾‘ï¼ˆç›´æ¥è°ƒç”¨confirmUploadå‰çš„å¤„ç†ï¼‰
                    handleEditedFile(editedFile);
                }

                // æƒ…å†µ2ï¼šå¦‚æœä¼ çš„æ˜¯Base64
                // if (typeof editedImage === 'string' && editedImage.startsWith('data:image/')) {
                //     fetch(editedImage)
                //         .then(res => res.blob())
                //         .then(blob => {
                //             const editedFile = new File([blob], fileName, { type: blob.type });
                //             handleEditedFile(editedFile);
                //         });
                // }
            }
        };

        window.addEventListener('message', handleMessage);

        // ç»„ä»¶é”€æ¯æ—¶ç§»é™¤ç›‘å¬
        onDestroy(() => {
            window.removeEventListener('message', handleMessage);
        });
    });

    // ========== æ–°å¢ï¼šå¤„ç†ç¼–è¾‘åçš„æ–‡ä»¶ ==========
    function handleEditedFile(file: File) {
        // ç¼“å­˜ç¼–è¾‘åçš„æ–‡ä»¶ï¼Œå±•ç¤ºåˆ°å¾…ä¸Šä¼ åŒºåŸŸ
        pendingFile = file;
        pendingFilePreviewUrl = URL.createObjectURL(file);
        alert('å·²æ¥æ”¶ç¼–è¾‘åçš„å›¾ç‰‡ï¼Œå¯ç‚¹å‡»ã€Œç¡®è®¤ä¸Šä¼ ã€å…¥åº“ï¼');
    }

  /**
   * ç¡®è®¤ä¸Šä¼ ï¼ˆä»…ç‚¹å‡»æ­¤æŒ‰é’®æ‰å…¥åº“ï¼‰
   */
  async function confirmUpload(): Promise<void> {
    if (!pendingFile) {
      alert('æœªé€‰ä¸­å¾…ä¸Šä¼ çš„å›¾ç‰‡ï¼');
      return;
    }

    await uploadImage(pendingFile);
    clearPendingFile();
  }

  /**
   * å–æ¶ˆä¸Šä¼ 
   */
  function cancelUpload(): void {
    clearPendingFile();
  }

  /**
   * æ¸…ç©ºå¾…ä¸Šä¼ æ–‡ä»¶ç¼“å­˜
   */
  function clearPendingFile(): void {
    if (pendingFilePreviewUrl) {
      URL.revokeObjectURL(pendingFilePreviewUrl);
      pendingFilePreviewUrl = '';
    }
    pendingFile = null;
  }

  /**
   * ä¸Šä¼ å›¾ç‰‡ï¼ˆä»…confirmUploadè°ƒç”¨ï¼‰
   */
  async function uploadImage(file: File): Promise<void> {
    if (!file || !productCode) {
      alert('é”™è¯¯ï¼šæ²¡æœ‰å¾…ä¸Šä¼ çš„å›¾ç‰‡æˆ–å•†å“è´§å·ä¸ºç©ºï¼');
      return;
    }

    isUploading = true;
    uploadProgress = 0;
    imgLoadError = false;

    try {
      const progressInterval = setInterval(() => {
        if (uploadProgress < 90) uploadProgress += 10;
      }, 100);

      const result = await api.uploadProductImage(
        productCode.trim(),
        file
      ) as ApiSuccessResponse<UploadImageResponseData>;

      clearInterval(progressInterval);
      uploadProgress = 100;

      if (result.status === 'success') {
        const newValue = result.data?.relative_path?.trim() || '';
        console.log('ã€ä¸Šä¼ å…¥åº“æˆåŠŸã€‘è·¯å¾„ï¼š', newValue);
        dispatch('change', newValue);
        value = newValue;
        alert('å›¾ç‰‡ä¸Šä¼ å…¥åº“æˆåŠŸï¼');
      }
    } catch (error) {
      const errorMsg = handleApiError(error, 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥');
      alert(`ä¸Šä¼ å¤±è´¥ï¼š${errorMsg}`);
      console.error('ã€ä¸Šä¼ é”™è¯¯ã€‘', error);
    } finally {
      isUploading = false;
      uploadProgress = 0;
    }
  }

  /**
   * æ¸…é™¤å·²ä¸Šä¼ å›¾ç‰‡
   */
  async function clearImage(): Promise<void> {
    if (!safeValue || isDeleting || !productCode) return;

    const confirmClear = confirm(`ç¡®è®¤åˆ é™¤è¯¥å›¾ç‰‡å—ï¼Ÿ\nè·¯å¾„ï¼š${safeValue}\nåˆ é™¤åæ— æ³•æ¢å¤ï¼`);
    if (!confirmClear) return;

    try {
      isDeleting = true;
      const deleteParams: BatchDeleteImageRequest = {
        featureIds: [],
        imagePaths: [safeValue],
        cleanCsv: true,
        relatedProductIds: [productCode.trim()]
      };

      const response = await fetch(DELETE_IMAGE_API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(deleteParams)
      });

      if (!response.ok) throw new Error(`åˆ é™¤å¤±è´¥ï¼š${response.status}`);
      const result: BatchDeleteImageResponse = await response.json();

      if (result.status === 'error') throw new Error(result.message);
      if (result.status === 'partial_success') {
        const failDetail = result.details.find(d => d.status === 'fail');
        alert(failDetail ? `éƒ¨åˆ†å¤±è´¥ï¼š${failDetail.message}` : 'åˆ é™¤æˆåŠŸï¼');
      } else {
        alert('å›¾ç‰‡åˆ é™¤æˆåŠŸï¼');
      }

      dispatch('change', '');
      value = '';
      previewUrlCache = '';
      imgLoadError = false;
    } catch (error) {
      const errorMsg = handleApiError(error, 'å›¾ç‰‡åˆ é™¤å¤±è´¥');
      alert(`æ¸…é™¤å¤±è´¥ï¼š${errorMsg}`);
    } finally {
      isDeleting = false;
    }
  }

  /**
   * ç”Ÿæˆå·²ä¸Šä¼ å›¾ç‰‡é¢„è§ˆURL
   */
  function getPreviewUrl(): string {
    if (!safeValue) return '';

    try {
      const pathStr = safeValue;
      if (pathStr.startsWith('http://') || pathStr.startsWith('https://')) {
        previewUrlCache = pathStr;
        debugPreviewUrl = pathStr;
        return previewUrlCache;
      }

      let safePath = pathStr.startsWith('image/') ? pathStr : `image/${pathStr}`;
      const encodedPath = encodeURIComponent(safePath).replace(/%2F/g, '/');
      previewUrlCache = `${IMAGE_API_BASE}?path=${encodedPath}`;
      debugPreviewUrl = previewUrlCache;

      return previewUrlCache;
    } catch (error) {
      console.error('ã€é¢„è§ˆURLé”™è¯¯ã€‘', error);
      imgLoadError = true;
      return ERROR_PLACEHOLDER;
    }
  }

  /**
   * å¤„ç†å›¾ç‰‡åŠ è½½é”™è¯¯
   */
  function handleImgError(e: ErrorEvent<HTMLImageElement>): void {
    imgLoadError = true;
    if (e.target?.src !== ERROR_PLACEHOLDER && !e.target?.src.startsWith('blob:')) {
      e.target.src = ERROR_PLACEHOLDER;
    }
  }

  // ========== å“åº”å¼çŠ¶æ€ ==========
  $: hasValidPath = Boolean(safeValue && safeValue.trim() !== '');
  $: combinedDisabled = disabled || !productCode || isUploading || isDeleting || isTempUploading;
  $: showUploadedSection = hasValidPath && !isUploading;
  $: showPendingSection = Boolean(pendingFile && pendingFilePreviewUrl);

  $: if (hasValidPath) {
    imgLoadError = false;
    getPreviewUrl();
  }

  // ========== ç»„ä»¶é”€æ¯æ¸…ç† ==========
  onDestroy(() => {
    if (previewUrlCache && previewUrlCache.startsWith('blob:')) {
      URL.revokeObjectURL(previewUrlCache);
    }
    if (pendingFilePreviewUrl && pendingFilePreviewUrl.startsWith('blob:')) {
      URL.revokeObjectURL(pendingFilePreviewUrl);
    }
  });
</script>

<div class="image-upload-container">
  <!-- 1. æ–‡ä»¶é€‰æ‹©åŒºåŸŸ -->
  <div class="upload-section">
    <input
      type="file"
      accept="image/png, image/jpg, image/jpeg, image/gif, image/bmp, image/webp"
      on:change={handleFileSelect}
      class="upload-input"
      disabled={combinedDisabled}
    />

    {#if !productCode && !disabled}
      <p class="warning-text">âš ï¸ è¯·å…ˆå¡«å†™å•†å“è´§å·</p>
    {/if}
  </div>

  <!-- 2. å¾…ä¸Šä¼ å›¾ç‰‡åŒºåŸŸ -->
  {#if showPendingSection}
    <div class="pending-section">
      <div class="pending-header">
        <span class="pending-title">å¾…ä¸Šä¼ å›¾ç‰‡</span>
      </div>
      <div class="pending-body">
        <!-- å¾…ä¸Šä¼ å›¾ç‰‡é¢„è§ˆ -->
        <div class="pending-preview">
          <img
            src={pendingFilePreviewUrl}
            alt="å¾…ä¸Šä¼ å›¾ç‰‡é¢„è§ˆ"
            class="pending-preview-img"
            on:error={handleImgError}
          />
        </div>
        <!-- æ–‡ä»¶ä¿¡æ¯ -->
        <div class="pending-file-info">
          <p><strong>æ–‡ä»¶åï¼š</strong>{pendingFile?.name}</p>
          <p><strong>å¤§å°ï¼š</strong>{pendingFile ? (pendingFile.size / 1024 / 1024).toFixed(2) + ' MB' : '-'}</p>
          <p><strong>æ ¼å¼ï¼š</strong>{pendingFile ? getFileExtension(pendingFile).toUpperCase() : '-'}</p>
          <p><strong>å•†å“è´§å·ï¼š</strong>{productCode}</p>
        </div>
        <!-- æ“ä½œæŒ‰é’®ï¼šç¼–è¾‘æŒ‰é’®è·³è½¬åˆ°æŒ‡å®šåœ°å€ -->
        <div class="pending-actions">
          <button
            type="button"
            class="edit-btn"
            on:click={editPendingImage}
            disabled={combinedDisabled || isUploading || isTempUploading}
            title="ç¼–è¾‘å›¾ç‰‡"
          >
            {isTempUploading ? 'ä¸Šä¼ ä¸­...' : 'âœï¸ ç¼–è¾‘å›¾ç‰‡'}
          </button>
          <button
            type="button"
            class="confirm-upload-btn"
            on:click={confirmUpload}
            disabled={combinedDisabled || isUploading}
            title="ç¡®è®¤ä¸Šä¼ "
          >
            {isUploading ? 'ä¸Šä¼ ä¸­...' : 'âœ… ç¡®è®¤ä¸Šä¼ '}
          </button>
          <button
            type="button"
            class="cancel-btn"
            on:click={cancelUpload}
            disabled={isUploading || isTempUploading}
            title="å–æ¶ˆä¸Šä¼ "
          >
            âŒ å–æ¶ˆ
          </button>
        </div>
      </div>
    </div>
  {/if}

  <!-- 3. ä¸Šä¼ ä¸­çŠ¶æ€ -->
  {#if isUploading}
    <div class="uploading-section">
      <div class="progress-container">
        <div class="progress-bar" style="width: {uploadProgress}%"></div>
        <div class="progress-text">{uploadProgress}%</div>
      </div>
      <p class="uploading-text">æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...</p>
    </div>
  {/if}

  <!-- 4. å·²ä¸Šä¼ å›¾ç‰‡åŒºåŸŸ -->
  {#if showUploadedSection}
    <div class="path-section">
      <div class="path-header">
        <label class="path-label">è·¯å¾„ï¼š</label>
        <button
          type="button"
          class="clear-btn"
          on:click={clearImage}
          disabled={isDeleting || !hasValidPath}
          title="åˆ é™¤å›¾ç‰‡å¹¶æ¸…ç©ºè·¯å¾„"
        >
          {isDeleting ? 'åˆ é™¤ä¸­...' : 'ğŸ—‘ï¸ æ¸…é™¤'}
        </button>
      </div>
      <input
        type="text"
        value={safeValue}
        readonly
        class="path-input"
        title="ç‚¹å‡»å¤åˆ¶è·¯å¾„"
        on:click={(e) => e.target.select()}
      />
      <div class="debug-text">
        é¢„è§ˆURLï¼š{debugPreviewUrl || 'æœªç”Ÿæˆ'}
      </div>
    </div>

    <div class="preview-wrapper">
      <img
        src={getPreviewUrl() || ERROR_PLACEHOLDER}
        alt="å•†å“å›¾ç‰‡é¢„è§ˆ"
        class="preview-img"
        on:error={handleImgError}
        title="å•†å“å›¾ç‰‡é¢„è§ˆ"
      />
      <p class="preview-text">
        <span class="preview-tip">å·²ä¸Šä¼ å›¾ç‰‡é¢„è§ˆ</span>
      </p>
    </div>
  {/if}
</div>

<style>
  .image-upload-container {
    margin: 4px 0;
    width: 100%;
    font-size: 11px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .upload-section {
    width: 100%;
  }

  .upload-input {
    padding: 4px 6px;
    border: 1px solid #ddd;
    border-radius: 3px;
    cursor: pointer;
    width: 100%;
    background-color: white;
    font-size: 10px;
    height: 30px;
  }

  .upload-input:disabled {
    cursor: not-allowed;
    background-color: #f5f5f5;
    opacity: 0.6;
  }

  /* å¾…ä¸Šä¼ å›¾ç‰‡åŒºåŸŸæ ·å¼ */
  .pending-section {
    padding: 8px;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    background-color: #fafafa;
  }

  .pending-header {
    margin-bottom: 6px;
    border-bottom: 1px dashed #eee;
    padding-bottom: 4px;
  }

  .pending-title {
    font-size: 10px;
    font-weight: 600;
    color: #333;
  }

  .pending-body {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .pending-preview {
    text-align: center;
  }

  .pending-preview-img {
    max-width: 120px;
    max-height: 100px;
    border: 1px solid #ced4da;
    border-radius: 3px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  .pending-file-info {
    font-size: 9px;
    color: #666;
    padding: 4px;
    background-color: #f9f9f9;
    border-radius: 3px;
  }

  .pending-file-info p {
    margin: 2px 0;
  }

  .pending-actions {
    display: flex;
    gap: 6px;
    justify-content: flex-start;
    flex-wrap: wrap;
  }

  /* ç¼–è¾‘æŒ‰é’®æ ·å¼ */
  .edit-btn {
    padding: 3px 8px;
    background-color: #2196f3;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 9px;
    display: flex;
    align-items: center;
    gap: 2px;
  }

  .edit-btn:hover:not(:disabled) {
    background-color: #1976d2;
  }

  .edit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  /* ç¡®è®¤ä¸Šä¼ æŒ‰é’® */
  .confirm-upload-btn {
    padding: 3px 8px;
    background-color: #4caf50;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 9px;
    display: flex;
    align-items: center;
    gap: 2px;
  }

  .confirm-upload-btn:hover:not(:disabled) {
    background-color: #43a047;
  }

  .confirm-upload-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  /* å–æ¶ˆæŒ‰é’® */
  .cancel-btn {
    padding: 3px 8px;
    background-color: #ff9800;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 9px;
    display: flex;
    align-items: center;
    gap: 2px;
  }

  .cancel-btn:hover:not(:disabled) {
    background-color: #f57c00;
  }

  .cancel-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  /* ä¸Šä¼ ä¸­çŠ¶æ€æ ·å¼ */
  .uploading-section {
    margin: 4px 0;
    padding: 8px;
    border: 1px solid #2196f3;
    border-radius: 4px;
    background-color: #e3f2fd;
  }

  .progress-container {
    position: relative;
    height: 20px;
    background-color: #eee;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 6px;
  }

  .progress-bar {
    height: 100%;
    background-color: #4caf50;
    transition: width 0.3s ease;
  }

  .progress-text {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 9px;
    font-weight: bold;
    color: #333;
  }

  .uploading-text {
    font-size: 9px;
    color: #2196f3;
    text-align: center;
    margin: 0;
  }

  /* å·²ä¸Šä¼ è·¯å¾„åŒºåŸŸæ ·å¼ */
  .path-section {
    margin: 2px 0;
    display: flex;
    flex-direction: column;
    gap: 2px;
    align-items: flex-start;
    width: 100%;
  }

  .path-header {
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
  }

  .path-label {
    font-weight: 500;
    color: #555;
    font-size: 10px;
    min-width: 40px;
  }

  /* æ¸…é™¤æŒ‰é’®æ ·å¼ */
  .clear-btn {
    padding: 2px 8px;
    background-color: #ff4444;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 9px;
    display: flex;
    align-items: center;
    gap: 2px;
    margin-left: auto;
  }

  .clear-btn:hover:not(:disabled) {
    background-color: #cc0000;
  }

  .clear-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .path-input {
    width: 100%;
    padding: 2px 4px;
    border: 1px solid #ddd;
    border-radius: 3px;
    background-color: #f9f9f9;
    font-size: 9px;
    color: #333;
    cursor: text;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    height: 24px;
  }

  .path-input:focus {
    outline: none;
    border-color: #3498db;
    background-color: #fff;
  }

  .debug-text {
    font-size: 8px;
    color: #999;
    margin-top: 2px;
    word-break: break-all;
    width: 100%;
  }

  .warning-text {
    color: #ff6b6b;
    font-size: 9px;
    margin: 2px 0 0 0;
    padding-left: 2px;
    line-height: 1.2;
  }

  /* å·²ä¸Šä¼ å›¾ç‰‡é¢„è§ˆåŒºåŸŸ */
  .preview-wrapper {
    margin-top: 4px;
    padding-top: 4px;
    border-top: 1px dashed #dee2e6;
    width: 100%;
  }

  .preview-img {
    max-width: 100px;
    max-height: 80px;
    border: 1px solid #ced4da;
    border-radius: 3px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  .preview-text {
    font-size: 9px;
    color: #666;
    margin: 2px 0 0 0;
  }

  .preview-tip {
    color: #999;
  }
</style>