def get_inventory_list():
    """查询库存列表 - 统一计算入库/出库/借/还后的库存数量"""
    try:
        csv_data = read_csv_data()

        # 获取所有相关表
        inventory_df = csv_data.get("inventory", pd.DataFrame())
        feature_df = csv_data.get("feature", pd.DataFrame())
        product_df = csv_data.get("product", pd.DataFrame())
        location_df = csv_data.get("location", pd.DataFrame())
        manufacturer_df = csv_data.get("manufacturer", pd.DataFrame())
        operation_df = csv_data.get("operation_record", pd.DataFrame())

        # 批量转换为可序列化格式
        inventory_list = df_to_serializable_list(inventory_df)
        feature_list = df_to_serializable_list(feature_df)
        product_list = df_to_serializable_list(product_df)
        location_list = df_to_serializable_list(location_df)
        manufacturer_list = df_to_serializable_list(manufacturer_df)
        operation_list = df_to_serializable_list(operation_df)

        # 构建索引字典
        feature_index = {}
        for feature in feature_list:
            feature_id = feature.get("商品特征ID")
            if feature_id not in feature_index:
                feature_index[feature_id] = feature

        product_index = {}
        for product in product_list:
            product_id = product.get("商品ID")
            if product_id not in product_index:
                product_index[product_id] = product

        location_index = {}
        for loc in location_list:
            location_id = loc.get("地址ID")
            if location_id not in location_index:
                location_index[location_id] = loc

        manufacturer_index = {}
        for mfr in manufacturer_list:
            manufacturer_id = mfr.get("厂家ID")
            if manufacturer_id not in manufacturer_index:
                manufacturer_index[manufacturer_id] = mfr

        # 建立操作记录索引（按关联库存ID）
        operation_index = {}
        for operation in operation_list:
            inv_id = operation.get("关联库存ID")
            if inv_id not in operation_index:
                operation_index[inv_id] = []
            operation_index[inv_id].append(operation)

        # 组装最终数据
        inventory_with_details = []
        for inv in inventory_list:
            # 获取关联ID
            feature_id = inv.get("关联商品特征ID")
            location_id = inv.get("关联位置ID")
            manufacturer_id = inv.get("关联厂家ID")
            inventory_id = inv.get("库存ID")

            # 获取商品特征信息
            feature_dict = {}
            if feature_id is not None and feature_id in feature_index:
                feature_dict = feature_index[feature_id]
                # 通过商品特征获取商品信息
                product_id = feature_dict.get("关联商品ID")
                if product_id is not None and product_id in product_index:
                    inv["商品信息"] = product_index[product_id]
                else:
                    inv["商品信息"] = {}

            # 获取位置信息
            if location_id is not None and location_id in location_index:
                inv["位置信息"] = location_index[location_id]
            else:
                inv["位置信息"] = {}

            # 获取厂家信息
            if manufacturer_id is not None and manufacturer_id in manufacturer_index:
                inv["厂家信息"] = manufacturer_index[manufacturer_id]
            else:
                inv["厂家信息"] = {}

            # 获取操作记录并统一计算库存数量
            if inventory_id is not None and inventory_id in operation_index:
                inv["操作记录"] = operation_index[inventory_id]
                # 计算入库/出库/借/还数量
                total_in = sum(op.get("操作数量", 0) for op in operation_index[inventory_id]
                               if op.get("操作类型") == "入库")
                total_out = sum(op.get("操作数量", 0) for op in operation_index[inventory_id]
                                if op.get("操作类型") == "出库")
                total_lend = sum(op.get("操作数量", 0) for op in operation_index[inventory_id]
                                 if op.get("操作类型") == "借")
                total_return = sum(op.get("操作数量", 0) for op in operation_index[inventory_id]
                                   if op.get("操作类型") == "还")

                # 统一计算当前库存
                inv["累计入库数量"] = total_in
                inv["累计出库数量"] = total_out
                inv["累计借出数量"] = total_lend
                inv["累计归还数量"] = total_return
                inv["库存数量"] = total_in - total_out - total_lend + total_return
            else:
                inv["操作记录"] = []
                inv["累计入库数量"] = 0
                inv["累计出库数量"] = 0
                inv["累计借出数量"] = 0
                inv["累计归还数量"] = 0
                inv["库存数量"] = inv.get("库存数量", 0)

            # 添加特征信息
            inv["特征信息"] = feature_dict

            inventory_with_details.append(inv)

        return {
            "status": "success",
            "data": inventory_with_details
        }, 200

    except Exception as e:
        print(f"查询库存异常: {str(e)}")
        return {"status": "error", "message": f"系统异常: {str(e)}"}, 500